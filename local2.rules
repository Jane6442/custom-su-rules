# ============================================
# PiRogue - Détections exfiltration & C2 TLS
# ============================================
# Contenu :
#   [A] Whitelist messageries par SNI (noalert)
#   [B] Uploads > 5 Mo (tous protocoles)
#   [C] C2 récurrent TLS (>5 connexions / 30 min) hors whitelist
#
# SIDs réservés : 800000–800199

# ----------------------------
# [A] WHITELIST TLS (par SNI)
# ----------------------------
# On marque les flux TLS connus (Signal/WhatsApp/Instagram/Facebook) pour exclusion.
# Ces règles ne génèrent PAS d'alertes.

#alert tls any any -> any any (msg:"WL SNI Signal"; tls.sni; pcre:"/(\.|^)signal\.org$/i"; flowbits:set,wl_msg; sid:800000; rev:1; noalert;)
#alert tls any any -> any any (msg:"WL SNI WhatsApp"; tls.sni; pcre:"/(\.|^)whatsapp\.(net|com)$/i"; flowbits:set,wl_msg; sid:800001; rev:1; noalert;)
#alert tls any any -> any any (msg:"WL SNI Instagram"; tls.sni; pcre:"/(\.|^)instagram\.com$/i"; flowbits:set,wl_msg; sid:800002; rev:1; noalert;)
#alert tls any any -> any any (msg:"WL SNI CDN Instagram"; tls.sni; pcre:"/(\.|^)cdninstagram\.com$/i"; flowbits:set,wl_msg; sid:800003; rev:1; noalert;)
#alert tls any any -> any any (msg:"WL SNI Facebook"; tls.sni; pcre:"/(\.|^)facebook\.com$/i"; flowbits:set,wl_msg; sid:800004; rev:1; noalert;)
#alert tls any any -> any any (msg:"WL SNI Meta CDN"; tls.sni; pcre:"/(\.|^)fbcdn\.net$/i"; flowbits:set,wl_msg; sid:800005; rev:1; noalert;)

# --------------------------------------------
# [B] EXFILTRATION : Upload total > 5 Mo
# --------------------------------------------
# [Counter] on cumule les octets envoyés vers le serveur pour chaque flux.
alert ip any any -> any any (
    msg:"[Counter] Upload bytes";
    flow:to_server,established;
    flowint:upload_bytes,+,dsize;
    sid:800010; rev:1; noalert;
)

# [Alerte] seuil dépassé : 5 Mo (5 * 1024 * 1024)
alert ip any any -> any any (
    msg:"EXFILTRATION possible : UPLOAD total > 5MB";
    flow:to_server,established;
    flowint:upload_bytes,>,5242880;
    flowbits:isnotset,upload_alerted;
    flowbits:set,upload_alerted;
    classtype:data-loss;
    sid:800011; rev:1;
)

# ----------------------------------------------------------------------
# [C] C2 RÉCURRENT (TLS) : > 5 connexions vers la même IP en 30 minutes
# ----------------------------------------------------------------------
# Idée : si le poste contacte souvent la même IP en TLS, hors services whitelistes,
# on suspecte un beaconing C2. On exclut les flux où le SNI match la whitelist.
#
# NB : on se base sur l'IP de destination (pas le SNI) pour agréger les occurrences.
# Avantage : fonctionne même si SNI absent. Inconvénient : SNI différent sur même IP
# est agrégé (acceptable pour une heuristique).
#
# On utilise un contenu négatif sur tls.sni pour exclure explicitement les domaines
# whitelistes (au cas où 'wl_msg' n'est pas posé pour une raison quelconque).

alert tls any any -> any any (
    msg:"C2 potentiel : connexions TLS récurrentes vers la même IP (>5 / 30min)";
    flow:to_server,established;
    flowbits:isnotset,wl_msg;
    tls.sni; content:!"signal.org"; nocase;
    tls.sni; content:!"whatsapp.net"; nocase;
    tls.sni; content:!"whatsapp.com"; nocase;
    tls.sni; content:!"instagram.com"; nocase;
    tls.sni; content:!"cdninstagram.com"; nocase;
    tls.sni; content:!"facebook.com"; nocase;
    tls.sni; content:!"fbcdn.net"; nocase;
    threshold:type both, track by_dst, count 6, seconds 1800;
    classtype:trojan-activity;
    sid:800020; rev:1;
)
